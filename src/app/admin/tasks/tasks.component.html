<div class="container-fluid tasks">
    <div class="row d-flex justify-content-start">
        <div class="d-flex flex-wrap justify-content-start card-container">
            <div class="mx-3 d-flex justify-content-end w-100" >
                <button
                    type="button"
                    class="btn btn-sm add-btn d-flex justify-content-between align-items-center ms-auto"
                    [ngClass]="isAddSectionOpen ? 'btn-outline-danger close': 'btn-outline-success'"
                    (click)="resetForm(); isAddSectionOpen = !isAddSectionOpen"
                >
                    <span class="me-2">{{isAddSectionOpen ? 'Close' : 'Add'}} Task</span>
                    <span class="material-icons-outlined add-close-icon fs-2">add</span>
                </button>
            </div> 

            <div class="card add-card noselect m-3" *ngIf="isAddSectionOpen" [@slideInOut]>
                <div class="card-body">
                    <form appInvalidFormFocus id="taskForm" [formGroup]="taskForm" *ngIf="taskForm" (submit)="submit()" autocomplete="off" class="row">                    
                        <div class="col-12 col-sm-6 col-md-4" >
                            <div class="form-group noLabel mb-3 w-100">
                                <label for="title" class="form-label">Title</label>
                                <input type="text" formControlName="title" id="title" class="form-control" required minlength="3" maxlength="100" trim="blur" >
    
                                <div *ngIf="isFormSubmittedAndError('title')" class="invalid-feedback">
                                    <ng-container *ngIf="isFormSubmittedAndError('title', 'required')">Title is required.</ng-container>
                                    <ng-container *ngIf="isFormSubmittedAndError('title', 'minlength', ['required'])">Title minimum 3 characters.</ng-container>
                                </div>
                            </div>
                        </div>

                        <div class="col-12 col-sm-6 col-md-4" >
                            <div class="form-group noLabel mb-3 w-100">
                                <label for="type" class="form-label">Type</label>
                                <ng-select bindLabel="type" formControlName="type" appendTo="body" [multiple]="false" [clearable]="false" class="form-select p-0 custom-ng-select" >
                                    <ng-option *ngFor="let type of taskTypes" [value]="type">{{type}}</ng-option>
                                </ng-select>

                                <div *ngIf="isFormSubmittedAndError('type')" class="invalid-feedback">
                                    <ng-container *ngIf="isFormSubmittedAndError('type', 'required')">Type is required.</ng-container>
                                </div>
                            </div>                      
                        </div> 
                        
                        <div class="col-12 col-sm-6 col-md-4" >
                            <div class="form-group noLabel mb-3 w-100">
                                <label for="reward" class="form-label">Reward in dollar ($)</label>
                                <input type="number" formControlName="reward" id="reward" class="form-control" required min="1" max="100000" trim="blur" >
                               
                                <div *ngIf="isFormSubmittedAndError('reward')" class="invalid-feedback">
                                    <ng-container *ngIf="isFormSubmittedAndError('reward', 'required')">Reward is required.</ng-container>
                                    <ng-container *ngIf="isFormSubmittedAndError('reward', 'min', ['required'])">Reward minimum value 1.</ng-container>
                                    <ng-container *ngIf="isFormSubmittedAndError('reward', 'max', ['required', 'min'])">Reward maximum value 100000.</ng-container>
                                </div>
                            </div>
                        </div>

                        <div class="col-12 col-sm-6 col-md-4" >
                            <div class="form-group noLabel mb-3 w-100">
                                <label for="rewardOnViews" class="form-label">Reward on views</label>
                                <input type="number" formControlName="rewardOnViews" id="rewardOnViews" class="form-control" required min="1" max="100000" trim="blur" >
    
                                <div *ngIf="isFormSubmittedAndError('rewardOnViews')" class="invalid-feedback">
                                    <ng-container *ngIf="isFormSubmittedAndError('rewardOnViews', 'required')">Reward on views is required.</ng-container>
                                    <ng-container *ngIf="isFormSubmittedAndError('rewardOnViews', 'min', ['required'])">Reward on views minimum value 1.</ng-container>
                                    <ng-container *ngIf="isFormSubmittedAndError('rewardOnViews', 'max', ['required', 'min'])">Reward on views maximum value 100000.</ng-container>
                                </div>
                            </div>
                        </div>    
                        
                        <div class="col-12 col-sm-12 col-md-8" >
                            <div class="form-group noLabel mb-3 w-100">
                                <label for="shop" class="form-label">Shop</label>
                                <ng-select bindLabel="shop" formControlName="shop" appendTo="body" [multiple]="false" [clearable]="false" class="form-select p-0 custom-ng-select" >
                                    <ng-option *ngFor="let shop of shops" [value]="shop?._id">{{shop?.name}}, {{shop?.type}}, {{shop?.address}}</ng-option>
                                </ng-select>

                                <div *ngIf="isFormSubmittedAndError('shop')" class="invalid-feedback">
                                    <ng-container *ngIf="isFormSubmittedAndError('shop', 'required')">Shop is required.</ng-container>
                                </div>
                            </div>                      
                        </div> 

                        <div class="col-12 col-sm-6 col-md-4" >
                            <div class="form-group noLabel mb-3 w-100">
                                <label for="task" class="form-label">Task</label>

                                <div class="d-flex flex-column justify-content-center align-items-center form-control p-4 img-picker-container" (click)="openImgCropperModal()">
                                    <ng-container *ngIf="!task.value" >
                                        <span class="material-icons-outlined img-picker-icon">file_upload</span>
                                        <div class="mt-2 text-secondary">Choose a Image file</div>
                                    </ng-container>  
                                    
                                    <ng-container *ngIf="task.value" >
                                        <img [src]="task.value" class="img-picker-preview img-thumbnail" />                    
                                    </ng-container>                                    
                                </div>
    
                                <div *ngIf="isFormSubmittedAndError('task')" class="invalid-feedback">
                                    <ng-container *ngIf="isFormSubmittedAndError('task', 'required')">Task is required.</ng-container>
                                </div>
                            </div>
                        </div>  
                    </form>
                </div>
                
                <div class="card-footer">                    
                    <button type="submit" class="btn btn-minfluence btn-lg w-100" [appBtnLoader]="isSubmited?.value" form="taskForm" >Submit</button>                                                
                </div>
            </div>
        </div>        
        
        <div class="d-flex flex-wrap justify-content-evenly align-items-stretch card-container pt-3" >            
            <div class="d-flex flex-wrap justify-content-between w-100">                       
                <div class="per-page mx-3 mb-4 d-flex justify-content-start align-items-center" >                 
                    <select class="form-select me-3" [formControl]="perPage" >
                        <option [ngValue]="3">3</option>
                        <option [ngValue]="6">6</option>
                        <option [ngValue]="9">9</option>
                        <option [ngValue]="12">12</option>
                        <option [ngValue]="15">15</option>
                        <option [ngValue]="18">18</option>
                        <option [ngValue]="21">21</option>
                    </select>
                    Per page tasks
                </div>            
    
                <div class="input-group search-box mx-3 mb-4">
                    <input class="form-control" type="text" [formControl]="search" placeholder="Search task" aria-label="Search for..." aria-describedby="btnNavbarSearch" />
                    
                    <button class="btn d-flex" [ngClass]="isAdvanceSearchSectionOpen ? 'btn-danger': 'btn-minfluence'" type="button" (click)="isAdvanceSearchSectionOpen = !isAdvanceSearchSectionOpen" >
                        <span class="material-icons-outlined me-2">{{isAdvanceSearchSectionOpen ? 'close' : 'search'}}</span> Advance
                    </button>
                </div>            
            </div> 
            
            <div class="card search-card noselect mx-3 mb-3" *ngIf="isAdvanceSearchSectionOpen" [@slideInOut]>
                <div class="card-body">
                    <form appInvalidFormFocus [formGroup]="advanceSearchForm" *ngIf="advanceSearchForm" autocomplete="off" class="row">                    
                        <div class="col-12 col-sm-6 col-md-4" >
                            <div class="form-group noLabel mb-3 w-100">
                                <label for="shop" class="form-label">Shop</label>
                                <ng-select bindLabel="shop" formControlName="shop" appendTo="body" [multiple]="false" [clearable]="false" class="form-select p-0 custom-ng-select" >
                                    <ng-option *ngFor="let shop of shops" [value]="shop?._id">{{shop?.name}}, {{shop?.type}}, {{shop?.address}}</ng-option>
                                </ng-select>
                            </div>   
                        </div>                                                                             
                    </form>
                </div>                            

                <div class="card-footer">                    
                    <button type="button" class="btn btn-minfluence btn-lg w-100" (click)="resetAdvanceSearch()" >Reset Filter</button>                                                
                </div>
            </div>

            <ng-container *ngIf="tasks?.data?.length > 0 && tasks?.isLoading === false">
                <div class="card data-card noselect mx-3 mb-5" *ngFor="let task of tasks?.data; trackBy:trackById" >
                    <div class="card-body" [style.background-image]="task.task ? 'url(' + backendUrl + task.task + ')' : ''" >                            
                        <div class="row m-3 p-2 data-container">
                            <div class="col-12 text-center">
                                <div class="fs-5" >
                                    <b>{{task?.title | titlecase}}</b>
                                </div>
                                <div class="fs-3 mb-3 mt-2" >
                                    <b>{{task?.reward | currency:'':'symbol':'1.2-2'}}</b> per <b>{{task?.rewardOnViews}}</b> views
                                </div>
                                    
                                
                                <div class="text-muted text-start fs-6 d-flex details-with-icon">
                                    <div class="icon">
                                        <i class="fas fa-share-alt fa-fw me-2 mt-1"></i>
                                    </div> 
                                    <span>Influence on {{task?.type}}</span>
                                </div>  
                                
                                <div class="text-muted text-start fs-6 d-flex details-with-icon">
                                    <div class="icon">
                                        <i class="fas fa-users fa-fw me-2 mt-1"></i>
                                    </div>
                                    <span>{{task?.users?.length}} Influence Taken</span>
                                </div>

                                <div class="text-muted text-start fs-6 d-flex details-with-icon">
                                    <div class="icon">
                                        <i class="fas fa-store-alt fa-fw me-2 mt-1"></i>
                                    </div> 
                                    <span>{{task?.shop?.name | titlecase}} ({{task?.shop?.type}} shop)</span>
                                </div>  

                                <div class="text-muted text-start fs-6 d-flex details-with-icon">
                                    <div class="icon">
                                        <i class="fas fa-map-marker-alt fa-fw me-2 mt-1"></i>
                                    </div> 
                                    <span>{{task?.shop?.address | titlecase}}</span>
                                </div>
                            </div>
                        </div>                        
                    </div>
    
                    <div class="card-footer">
                        <button type="button" class="btn btn-lg btn-outline-success w-100 edit" (click)="editForm(task)" >
                            <i class="far fa-edit me-2"></i> Edit
                        </button>
                        
                        <button type="button" class="btn btn-lg btn-outline-warning w-100 rounded-0" (click)="opneTaskDetailModal(task)">
                            <i class="fas fa-table me-2"></i> Details
                        </button>

                        <button type="button" class="btn btn-lg btn-outline-danger w-100 delete" (click)="deleteRecord(task?._id)" >
                            <i class="far fa-trash-alt me-2"></i> Delete
                        </button>
                    </div>
                </div>

                <div class="w-100 d-flex justify-content-between mx-3 mb-4" *ngIf="documents.value > 0" >
                    <div>Showing {{(page.value - 1) * perPage.value || 1}} to {{((page.value * perPage.value) > documents.value) ? documents.value : (page.value * perPage.value)}} of {{documents.value}} tasks</div>
                    <ngb-pagination [page]="page.value" [collectionSize]="documents.value" [pageSize]="perPage.value" (pageChange)="page.setValue($event)" [maxSize]="5" [rotate]="true" [boundaryLinks]="true" ></ngb-pagination>                            
                </div>
            </ng-container>                       

            <div class="card noselect loading-and-no-data-card mx-3 mb-4" *ngIf="tasks?.data?.length === 0 || tasks?.isLoading === true">
                <div class="card-body d-flex flex-column justify-content-center align-items-center">
                    <img [src]="tasks?.isLoading ? 'assets/img/loading.jpg' : 'assets/img/no-data.jpg'" alt="" srcset="">
                    <div class="mb-5" >{{tasks?.isLoading ? 'Loading Data' : 'Data Not Found'}}</div>
                </div>
            </div>            
        </div>
    </div>    
</div>